<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://cdn.jsdelivr.net; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
  <title>AutoTax — Fatura Yönetimi</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .topbar-user {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 16px 0;
      justify-content: flex-end;
      font-size: 13px; color: var(--text-muted, #64748b);
    }
    .topbar-user .plan-chip {
      background: #2563eb; color: #fff;
      font-size: 11px; font-weight: 700;
      padding: 2px 8px; border-radius: 20px; letter-spacing: .4px;
    }
    .topbar-user .plan-chip.free       { background: #64748b; }
    .topbar-user .plan-chip.pro        { background: #2563eb; }
    .topbar-user .plan-chip.enterprise { background: #7c3aed; }
    .topbar-user .usage-txt { font-size: 12px; }
    .topbar-user .btn-logout {
      background: none; border: 1px solid #e2e8f0; border-radius: 8px;
      padding: 4px 12px; font-size: 12px; color: #64748b;
      cursor: pointer; transition: border-color .2s, color .2s;
    }
    .topbar-user .btn-logout:hover { border-color: #ef4444; color: #ef4444; }
    .topbar-user .user-name { font-weight: 600; color: var(--text, #0f172a); }
    .quota-bar-wrap { height: 4px; width: 80px; background: #e2e8f0; border-radius: 2px; overflow: hidden; }
    .quota-bar { height: 100%; background: #2563eb; border-radius: 2px; transition: width .4s; }
    .quota-bar.warn { background: #f59e0b; }
    .quota-bar.over { background: #ef4444; }
  </style>
</head>
<body>
<script>
(function(){
  var tok = localStorage.getItem('at_token');
  if(!tok) { window.location.replace('/login.html'); }
})();
</script>

<!-- ═══ TOPBAR: Kullanıcı / Plan / Çıkış ════════════════ -->
<div class="topbar-user" id="topbar-user" style="display:none">
  <span class="user-name" id="tb-name"></span>
  <span class="plan-chip" id="tb-plan"></span>
  <div>
    <div class="quota-bar-wrap"><div class="quota-bar" id="tb-quota-bar" style="width:0%"></div></div>
    <span class="usage-txt" id="tb-usage"></span>
  </div>
  <button class="btn-logout" id="btn-logout">Çıkış</button>
</div>

<!-- ═══════════════════════════════════════ SIDEBAR ══════ -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="16" y1="13" x2="8" y2="13"/>
      <line x1="16" y1="17" x2="8" y2="17"/>
      <polyline points="10 9 9 9 8 9"/>
    </svg>
    <span>AutoTax</span>
  </div>
  <ul class="nav-links">
    <li class="active" data-view="dashboard">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
        <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </li>
    <li data-view="upload">
      <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Yükle / OCR
    </li>
    <li data-view="invoices">
      <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
      Faturalar
    </li>
    <li data-view="review">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      İnceleme Kuyruğu <span class="badge-count" id="reviewBadge" style="display:none">0</span>
    </li>
    <li data-view="stats">
      <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
        <line x1="6" y1="20" x2="6" y2="14"/></svg>
      İstatistik
    </li>
  </ul>
  <div class="sidebar-bottom">
    <button id="themeToggle" class="btn-icon" title="Tema Değiştir">
      <svg id="themeIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    </button>
    <span id="apiStatus" class="status-badge status-idle">API Bekleniyor</span>
  </div>
</nav>

<!-- ═══════════════════════════════════════ MAIN ═════════ -->
<main class="main-content">

  <!-- ─── DASHBOARD ─── -->
  <section id="view-dashboard" class="view active">
    <div class="page-header"><h1>Dashboard</h1></div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon kpi-blue">
          <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">Toplam Fatura</span>
          <span class="kpi-value" id="kpiCount">—</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon kpi-green">
          <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">Toplam Tutar</span>
          <span class="kpi-value" id="kpiTotal">—</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon kpi-amber">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">İnceleme Bekleyen</span>
          <span class="kpi-value" id="kpiReview">—</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon kpi-purple">
          <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">Toplam KDV</span>
          <span class="kpi-value" id="kpiVat">—</span>
        </div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Aylık Harcama</h3>
        <canvas id="chartMonthly"></canvas>
      </div>
      <div class="chart-card">
        <h3>Kategori Dağılımı</h3>
        <canvas id="chartCategory"></canvas>
      </div>
    </div>
    <div class="chart-card" style="margin-top:16px">
      <h3>Firma Bazlı Toplamlar</h3>
      <div id="vendorChips"></div>
    </div>
  </section>

  <!-- ─── UPLOAD ─── -->
  <section id="view-upload" class="view">
    <div class="page-header"><h1>Fatura Yükle &amp; OCR</h1></div>
    <div class="upload-card">
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" multiple accept="image/*,.pdf">
        <div class="drop-content">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <p>Fatura, fiş veya PDF'i buraya sürükleyin</p>
          <small>JPG · PNG · PDF — çoklu seçim desteklenir · 7 dil OCR</small>
          <label for="fileInput" class="btn btn-primary" style="margin-top:12px;cursor:pointer">Dosya Seç</label>
        </div>
      </div>
      <div id="fileList" class="file-list"></div>
      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <button id="uploadBtn" class="btn btn-primary" disabled>OCR Başlat</button>
        <div id="uploadProgressWrap" style="flex:1;display:none">
          <div class="progress-track"><div id="progressFill" class="progress-fill"></div></div>
          <small id="progressLabel" style="color:var(--muted)">İşleniyor…</small>
        </div>
      </div>
      <div id="uploadLog" class="upload-log"></div>
    </div>
  </section>

  <!-- ─── FATURALAR ─── -->
  <section id="view-invoices" class="view">
    <div class="page-header">
      <h1>Faturalar</h1>
      <div class="page-actions">
        <button id="exportExcel" class="btn btn-success">Excel İndir</button>
        <button id="exportJSON"  class="btn btn-outline">JSON İndir</button>
        <button id="exportFull"  class="btn btn-purple">Tam Rapor</button>
        <a id="exportServerExcel" href="/api/stats/export/excel" target="_blank" class="btn btn-success">Sunucu Excel</a>
      </div>
    </div>

    <!-- Filtreler -->
    <div class="filter-bar">
      <div class="fg"><label>Tarih Başlangıç</label><input type="date" id="fDateFrom"></div>
      <div class="fg"><label>Tarih Bitiş</label><input type="date" id="fDateTo"></div>
      <div class="fg fg-grow"><label>Firma Ara</label><input type="text" id="fVendor" placeholder="Ara…"></div>
      <div class="fg">
        <label>Kategori</label>
        <select id="fCategory">
          <option value="">Tümü</option>
          <option value="food">Yemek</option>
          <option value="grocery">Market</option>
          <option value="transport">Ulaşım</option>
          <option value="fuel">Akaryakıt</option>
          <option value="hotel">Otel</option>
          <option value="health">Sağlık</option>
          <option value="electronics">Elektronik</option>
          <option value="clothing">Giyim</option>
        </select>
      </div>
      <div class="fg"><label>Min Tutar</label><input type="number" id="fMin" placeholder="0"></div>
      <div class="fg"><label>Max Tutar</label><input type="number" id="fMax" placeholder="∞"></div>
      <div class="fg fg-btn">
        <button id="applyFilter" class="btn btn-primary">Filtrele</button>
        <button id="resetFilter" class="btn btn-ghost">Sıfırla</button>
      </div>
    </div>

    <!-- Özet -->
    <div class="summary-row">
      <span>Gösterilen: <strong id="fCount">0</strong></span>
      <span>Toplam: <strong id="fTotal" class="text-primary">—</strong></span>
      <span>KDV: <strong id="fVat">—</strong></span>
    </div>

    <!-- Tablo -->
    <div class="table-wrap">
      <table id="invoiceTable">
        <thead>
          <tr>
            <th class="th-chk"><input type="checkbox" id="selAll"></th>
            <th data-col="filename">Dosya</th>
            <th data-col="vendor">Firma</th>
            <th data-col="date">Tarih</th>
            <th data-col="time">Saat</th>
            <th data-col="total"  class="num">Tutar</th>
            <th data-col="vat_rate" class="num">KDV%</th>
            <th data-col="vat_amount" class="num">KDV Tutarı</th>
            <th data-col="invoice_no">Fatura No</th>
            <th data-col="category">Kategori</th>
            <th data-col="payment_method">Ödeme</th>
            <th>QR</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tBody"></tbody>
        <tfoot id="tFoot">
          <tr class="excel-footer">
            <td colspan="2" class="ef-label">
              <select id="efFunc" class="ef-select" title="Fonksiyon seç">
                <option value="SUM">∑ TOPLAM</option>
                <option value="AVG">∅ ORTALAMA</option>
                <option value="MIN">↓ MİN</option>
                <option value="MAX">↑ MAKS</option>
                <option value="COUNT">N ADET</option>
                <option value="POS">+ POZİTİF TOP.</option>
                <option value="NEG">– NEGATİF TOP.</option>
              </select>
            </td>
            <td class="ef-vendor"></td>
            <td class="ef-date"></td>
            <td></td>
            <td class="num ef-total" id="efTotal">—</td>
            <td class="num ef-vat-rate" id="efVatRate">—</td>
            <td class="num ef-vat" id="efVat">—</td>
            <td></td>
            <td colspan="4" class="ef-info" id="efInfo"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
  </section>

  <!-- ─── İNCELEME KUYRUĞU ─── -->
  <section id="view-review" class="view">
    <div class="page-header">
      <h1>İnceleme Kuyruğu</h1>
      <div class="page-actions">
        <span id="rqCount" class="kpi-chip">0 bekliyor</span>
        <button id="rqRefresh" class="btn btn-outline">Yenile</button>
        <a id="rqExportExcel" href="/api/stats/export/review-queue-excel" class="btn btn-warning" download>
          Excel İndir
        </a>
        <a id="rqExportCsv" href="/api/stats/export/review-queue-csv" class="btn btn-outline" download>
          CSV İndir
        </a>
      </div>
    </div>

    <!-- Uyarı banner -->
    <div class="review-banner" id="rqBanner" style="display:none">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <div>
        <strong>Okunamayan / Eksik Faturalar</strong>
        <p id="rqBannerMsg">Aşağıdaki faturalarda bazı bilgiler tespit edilemedi. Lütfen elle girin veya geçin.</p>
      </div>
    </div>

    <div id="reviewList" class="review-list"></div>
    <div class="pagination" id="rqPagination"></div>
  </section>

  <!-- ─── İSTATİSTİK ─── -->
  <section id="view-stats" class="view">
    <div class="page-header"><h1>İstatistik &amp; Sorgulama</h1></div>
    <div class="stats-form">
      <div class="fg"><label>Başlangıç</label><input type="date" id="sDateFrom"></div>
      <div class="fg"><label>Bitiş</label><input type="date" id="sDateTo"></div>
      <div class="fg fg-grow"><label>Firma</label><input type="text" id="sVendor" placeholder="Tümü"></div>
      <div class="fg">
        <label>Kategori</label>
        <select id="sCategory">
          <option value="">Tümü</option>
          <option value="food">Yemek</option>
          <option value="grocery">Market</option>
          <option value="transport">Ulaşım</option>
          <option value="fuel">Akaryakıt</option>
          <option value="hotel">Otel</option>
          <option value="health">Sağlık</option>
          <option value="electronics">Elektronik</option>
          <option value="clothing">Giyim</option>
        </select>
      </div>
      <div class="fg"><label>Min Tutar</label><input type="number" id="sMin"></div>
      <div class="fg"><label>Max Tutar</label><input type="number" id="sMax"></div>
      <button id="runStats" class="btn btn-primary" style="align-self:flex-end">Sorgula</button>
    </div>
    <div id="statsResult" class="stats-result"></div>
  </section>

</main>

<!-- ═══════════════════════════════════════ MODAL ════════ -->
<div id="modal" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <div class="modal-hdr">
      <h2 id="modalTitle">Detay</h2>
      <button id="modalClose" class="btn-icon">✕</button>
    </div>
    <div class="modal-body">
      <div id="detailGrid" class="detail-grid"></div>
      <div class="detail-section">
        <h4>QR / Barkod</h4>
        <pre id="detailQR">—</pre>
      </div>
      <div class="detail-section">
        <h4>OCR Ham Metin</h4>
        <pre id="detailRaw">—</pre>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════ MANUEL DÜZELTME MODAL ═══════════════ -->
<div id="editModal" class="modal-overlay" style="display:none">
  <div class="modal-box modal-edit">
    <div class="modal-hdr">
      <div>
        <h2 id="editModalTitle">Fatura Düzenle</h2>
        <p id="editModalSub" style="font-size:12px;color:#64748b;margin-top:2px"></p>
      </div>
      <button id="editModalClose" class="btn-icon">✕</button>
    </div>

    <!-- Uyarı şeridi -->
    <div id="editWarning" class="edit-warning" style="display:none">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <span id="editWarningMsg"></span>
    </div>

    <div class="modal-body">
      <input type="hidden" id="editInvId">
      <div class="edit-grid">
        <div class="eg">
          <label>Firma Adı</label>
          <input type="text" id="eVendor" placeholder="Firma adı…">
        </div>
        <div class="eg">
          <label>Fatura No</label>
          <input type="text" id="eInvoiceNo" placeholder="Fatura numarası…">
        </div>
        <div class="eg">
          <label>Tarih</label>
          <input type="date" id="eDate">
        </div>
        <div class="eg">
          <label>Saat</label>
          <input type="time" id="eTime">
        </div>
        <div class="eg eg-required">
          <label>Toplam Tutar <span class="req-star">*</span></label>
          <input type="number" id="eTotal" step="0.01" placeholder="0.00" required>
        </div>
        <div class="eg">
          <label>KDV %</label>
          <input type="number" id="eVatRate" step="1" min="0" max="100" placeholder="19">
        </div>
        <div class="eg">
          <label>KDV Tutarı</label>
          <input type="number" id="eVatAmount" step="0.01" placeholder="0.00">
        </div>
        <div class="eg">
          <label>Kategori</label>
          <select id="eCategory">
            <option value="">— Seçin —</option>
            <option value="food">Yemek</option>
            <option value="grocery">Market</option>
            <option value="transport">Ulaşım</option>
            <option value="fuel">Akaryakıt</option>
            <option value="hotel">Otel</option>
            <option value="health">Sağlık</option>
            <option value="electronics">Elektronik</option>
            <option value="clothing">Giyim</option>
            <option value="other">Diğer</option>
          </select>
        </div>
        <div class="eg">
          <label>Ödeme Yöntemi</label>
          <select id="ePayment">
            <option value="">— Seçin —</option>
            <option value="cash">Nakit</option>
            <option value="credit_card">Kredi Kartı</option>
            <option value="debit_card">Banka Kartı</option>
            <option value="bank_transfer">Havale</option>
          </select>
        </div>
      </div>

      <!-- KDV otomatik hesap -->
      <div class="vat-auto-row">
        <label class="checkbox-label">
          <input type="checkbox" id="eVatAuto" checked>
          KDV tutarını otomatik hesapla (Tutar × KDV%)
        </label>
      </div>

      <div class="edit-actions">
        <button id="editSkipBtn" class="btn btn-ghost">Geç (İncelemeden Kaldır)</button>
        <button id="editSaveBtn" class="btn btn-primary">Kaydet</button>
      </div>

      <div id="editFeedback" class="edit-feedback" style="display:none"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="app.js" type="module"></script>
</body>
</html>
