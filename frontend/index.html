<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://cdn.jsdelivr.net; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; worker-src 'self';">
  <title>AutoTax.cloud â€” AkÄ±llÄ± Fatura YÃ¶netimi</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AutoTax">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">

  <link rel="stylesheet" href="style.css">
  <style>
    .topbar-user {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 16px 0;
      justify-content: flex-end;
      font-size: 13px; color: var(--text-muted, #64748b);
    }
    .topbar-user .plan-chip {
      background: #2563eb; color: #fff;
      font-size: 11px; font-weight: 700;
      padding: 2px 8px; border-radius: 20px; letter-spacing: .4px;
    }
    .topbar-user .plan-chip.free       { background: #64748b; }
    .topbar-user .plan-chip.pro        { background: #2563eb; }
    .topbar-user .plan-chip.enterprise { background: #7c3aed; }
    .topbar-user .usage-txt { font-size: 12px; }
    .topbar-user .btn-logout {
      background: none; border: 1px solid #e2e8f0; border-radius: 8px;
      padding: 4px 12px; font-size: 12px; color: #64748b;
      cursor: pointer; transition: border-color .2s, color .2s;
    }
    .topbar-user .btn-logout:hover { border-color: #ef4444; color: #ef4444; }
    .topbar-user .user-name { font-weight: 600; color: var(--text, #0f172a); }
    .quota-bar-wrap { height: 4px; width: 80px; background: #e2e8f0; border-radius: 2px; overflow: hidden; }
    .quota-bar { height: 100%; background: #2563eb; border-radius: 2px; transition: width .4s; }
    .quota-bar.warn { background: #f59e0b; }
    .quota-bar.over { background: #ef4444; }
  </style>
</head>
<body>
<script>
(function(){
  var tok = localStorage.getItem('at_token');
  if(!tok) { window.location.replace('/login.html'); }
})();
</script>

<!-- â•â•â• TOPBAR: KullanÄ±cÄ± / Plan / Ã‡Ä±kÄ±ÅŸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="topbar-user" id="topbar-user" style="display:none">
  <span class="user-name" id="tb-name"></span>
  <span class="plan-chip" id="tb-plan"></span>
  <div>
    <div class="quota-bar-wrap"><div class="quota-bar" id="tb-quota-bar" style="width:0%"></div></div>
    <span class="usage-txt" id="tb-usage"></span>
  </div>
  <button class="btn-logout" id="btn-logout">Ã‡Ä±kÄ±ÅŸ</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â• -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="16" y1="13" x2="8" y2="13"/>
      <line x1="16" y1="17" x2="8" y2="17"/>
      <polyline points="10 9 9 9 8 9"/>
    </svg>
    <span>AutoTax<b>.cloud</b></span>
  </div>
  <ul class="nav-links">
    <li class="active" data-view="dashboard">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
        <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </li>
    <li data-view="upload">
      <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      YÃ¼kle / OCR
    </li>
    <li data-view="invoices">
      <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
      Faturalar
    </li>
    <li data-view="review">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      Ä°nceleme KuyruÄŸu <span class="badge-count" id="reviewBadge" style="display:none">0</span>
    </li>
    <li data-view="stats">
      <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
        <line x1="6" y1="20" x2="6" y2="14"/></svg>
      Ä°statistik
    </li>
    <li data-view="ledger">
      <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      Muhasebe Defteri
    </li>
    <li data-view="settings">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Dil AyarlarÄ±
    </li>
  </ul>
  <div class="sidebar-bottom">
    <!-- PWA: Ana Ekrana Ekle butonu -->
    <button id="btnInstallApp" onclick="installApp()" style="display:none">
      <svg viewBox="0 0 24 24"><path d="M12 16V4m0 12-4-4m4 4 4-4"/><rect x="2" y="14" width="20" height="6" rx="2"/></svg>
      UygulamayÄ± YÃ¼kle
    </button>
    <!-- Plan bilgisi -->
    <div class="plan-widget" id="planWidget">
      <div class="plan-top">
        <span class="plan-badge" id="planBadge">Free</span>
        <a href="/landing.html#pricing" class="plan-upgrade" id="planUpgrade" style="display:none">YÃ¼kselt â†‘</a>
      </div>
      <div class="plan-bar-wrap" id="planBarWrap" style="display:none">
        <div class="plan-bar-track">
          <div class="plan-bar-fill" id="planBarFill" style="width:0%"></div>
        </div>
        <span class="plan-bar-label" id="planBarLabel">0 / 50</span>
      </div>
    </div>
    <button id="themeToggle" class="btn-icon" title="Tema DeÄŸiÅŸtir">
      <svg id="themeIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    </button>
    <span id="apiStatus" class="status-badge status-idle">API Bekleniyor</span>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â• -->
<main class="main-content">

  <!-- â”€â”€â”€ DASHBOARD â”€â”€â”€ -->
  <section id="view-dashboard" class="view active">
    <div class="page-header"><h1>Dashboard</h1></div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon kpi-blue">
          <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">Toplam Fatura</span>
          <span class="kpi-value" id="kpiCount">â€”</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon kpi-green">
          <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">Toplam Tutar</span>
          <span class="kpi-value" id="kpiTotal">â€”</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon kpi-amber">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">Ä°nceleme Bekleyen</span>
          <span class="kpi-value" id="kpiReview">â€”</span>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon kpi-purple">
          <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        </div>
        <div class="kpi-body">
          <span class="kpi-label">Toplam KDV</span>
          <span class="kpi-value" id="kpiVat">â€”</span>
        </div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <h3>AylÄ±k Harcama</h3>
        <canvas id="chartMonthly"></canvas>
      </div>
      <div class="chart-card">
        <h3>Kategori DaÄŸÄ±lÄ±mÄ±</h3>
        <canvas id="chartCategory"></canvas>
      </div>
    </div>
    <div class="chart-card" style="margin-top:16px">
      <h3>Firma BazlÄ± Toplamlar</h3>
      <div id="vendorChips"></div>
    </div>
  </section>

  <!-- â”€â”€â”€ UPLOAD â”€â”€â”€ -->
  <section id="view-upload" class="view">
    <div class="page-header"><h1>Fatura YÃ¼kle &amp; OCR</h1></div>
    <div class="upload-card">
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" multiple accept="image/*,.pdf">
        <div class="drop-content">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <p>Fatura, fiÅŸ veya PDF'i buraya sÃ¼rÃ¼kleyin</p>
          <small>JPG Â· PNG Â· PDF â€” Ã§oklu seÃ§im desteklenir Â· 7 dil OCR</small>
          <label for="fileInput" class="btn btn-primary" style="margin-top:12px;cursor:pointer">ğŸ“ Dosya SeÃ§</label>
        </div>
      </div>

      <!-- Kamera / Ekran / TarayÄ±cÄ± butonlarÄ± -->
      <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
        <button id="btnCamera"  class="btn btn-outline" title="Kamera ile Ã§ek">ğŸ“· Kamera ile Ã‡ek</button>
        <button id="btnScreen"  class="btn btn-outline" title="Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ al">ğŸ–¥ï¸ Ekran GÃ¶rÃ¼ntÃ¼sÃ¼</button>
        <button id="btnQR"      class="btn btn-outline" title="QR kod oku">ğŸ”² QR Kod Oku</button>
        <button id="btnScanner" class="btn btn-outline" title="TarayÄ±cÄ±dan yÃ¼kle" style="border-color:#a78bfa;color:#a78bfa">ğŸ“  TarayÄ±cÄ± BaÄŸla</button>
      </div>

      <!-- TarayÄ±cÄ± yardÄ±m modalÄ± -->
      <div id="scannerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;align-items:center;justify-content:center">
        <div style="background:#1e1e2e;border-radius:16px;padding:28px;max-width:560px;width:95%">
          <h3 style="margin:0 0 16px;color:#a78bfa;font-size:18px">ğŸ“  TarayÄ±cÄ± ile Fatura YÃ¼kle</h3>
          <p style="color:#ccc;margin:0 0 12px;font-size:14px">Fiziksel tarayÄ±cÄ±nÄ±zÄ± bilgisayarÄ±nÄ±zÄ±n tarama uygulamasÄ±yla kullanÄ±p Ã§Ä±ktÄ±yÄ± buraya yÃ¼kleyin:</p>

          <div style="background:#13131f;border-radius:10px;padding:16px;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
              <span style="background:#a78bfa;color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">1</span>
              <span style="color:#ddd;font-size:14px"><strong>Windows:</strong> BaÅŸlat â†’ "Windows Faks ve Tarama" â†’ Yeni Tarama â†’ PDF veya JPG olarak kaydet</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
              <span style="background:#a78bfa;color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">2</span>
              <span style="color:#ddd;font-size:14px"><strong>Mac:</strong> "Image Capture" uygulamasÄ± â†’ Tara â†’ PDF/JPG kaydet</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span style="background:#a78bfa;color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">3</span>
              <span style="color:#ddd;font-size:14px">Kaydedilen dosyayÄ± aÅŸaÄŸÄ±daki "Tarama DosyasÄ± SeÃ§" butonuyla yÃ¼kleyin</span>
            </div>
          </div>

          <!-- TarayÄ±cÄ± Ã§Ä±ktÄ±sÄ± iÃ§in gizli input â€” PDF de kabul eder, yÃ¼ksek DPI -->
          <input type="file" id="scannerFileInput" multiple accept="image/*,.pdf" style="display:none">

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <label for="scannerFileInput" class="btn btn-primary" style="cursor:pointer;background:#a78bfa;border-color:#a78bfa">ğŸ“ Tarama DosyasÄ± SeÃ§</label>
            <button id="btnScannerWinScan" class="btn btn-outline" style="border-color:#a78bfa;color:#a78bfa" title="Windows Faks ve Tarama aÃ§">ğŸªŸ Windows Tarama AÃ§</button>
            <button id="btnScannerClose" class="btn btn-outline">Kapat</button>
          </div>

          <div id="scannerUploadStatus" style="margin-top:12px;font-size:13px;color:#888"></div>
        </div>
      </div>

      <!-- Kamera Ã¶nizleme modalÄ± -->
      <div id="cameraModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;align-items:center;justify-content:center">
        <div style="background:#1e1e2e;border-radius:16px;padding:20px;max-width:520px;width:95%;text-align:center">
          <video id="cameraVideo" autoplay playsinline style="width:100%;border-radius:8px;max-height:340px;object-fit:cover"></video>
          <canvas id="cameraCanvas" style="display:none"></canvas>
          <div style="display:flex;gap:10px;margin-top:14px;justify-content:center">
            <button id="btnCapture" class="btn btn-primary">ğŸ“¸ Ã‡ek &amp; YÃ¼kle</button>
            <button id="btnCameraClose" class="btn btn-outline">Ä°ptal</button>
          </div>
        </div>
      </div>

      <div id="fileList" class="file-list"></div>
      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <button id="uploadBtn" class="btn btn-primary" disabled>OCR BaÅŸlat</button>
        <div id="uploadProgressWrap" style="flex:1;display:none">
          <div class="progress-track"><div id="progressFill" class="progress-fill"></div></div>
          <small id="progressLabel" style="color:var(--muted)">Ä°ÅŸleniyorâ€¦</small>
        </div>
      </div>
      <div id="uploadLog" class="upload-log"></div>
    </div>
  </section>

  <!-- â”€â”€â”€ FATURALAR â”€â”€â”€ -->
  <section id="view-invoices" class="view">
    <div class="page-header">
      <h1>Faturalar</h1>
      <div class="page-actions">
        <button id="exportExcel" class="btn btn-success">Excel Ä°ndir</button>
        <button id="exportJSON"  class="btn btn-outline">JSON Ä°ndir</button>
        <button id="exportFull"  class="btn btn-purple">Tam Rapor</button>
        <a id="exportServerExcel" href="/api/stats/export/excel" target="_blank" class="btn btn-success">Sunucu Excel</a>
      </div>
    </div>

    <!-- Filtreler -->
    <div class="filter-bar">
      <div class="fg"><label>Tarih BaÅŸlangÄ±Ã§</label><input type="date" id="fDateFrom"></div>
      <div class="fg"><label>Tarih BitiÅŸ</label><input type="date" id="fDateTo"></div>
      <div class="fg fg-grow"><label>Firma Ara</label><input type="text" id="fVendor" placeholder="Araâ€¦"></div>
      <div class="fg">
        <label>Kategori</label>
        <select id="fCategory">
          <option value="">TÃ¼mÃ¼</option>
          <option value="food">Yemek</option>
          <option value="grocery">Market</option>
          <option value="transport">UlaÅŸÄ±m</option>
          <option value="fuel">AkaryakÄ±t</option>
          <option value="hotel">Otel</option>
          <option value="health">SaÄŸlÄ±k</option>
          <option value="electronics">Elektronik</option>
          <option value="clothing">Giyim</option>
        </select>
      </div>
      <div class="fg"><label>Min Tutar</label><input type="number" id="fMin" placeholder="0"></div>
      <div class="fg"><label>Max Tutar</label><input type="number" id="fMax" placeholder="âˆ"></div>
      <div class="fg fg-btn">
        <button id="applyFilter" class="btn btn-primary">Filtrele</button>
        <button id="resetFilter" class="btn btn-ghost">SÄ±fÄ±rla</button>
      </div>
    </div>

    <!-- Ã–zet -->
    <div class="summary-row">
      <span>GÃ¶sterilen: <strong id="fCount">0</strong></span>
      <span>Toplam: <strong id="fTotal" class="text-primary">â€”</strong></span>
      <span>KDV: <strong id="fVat">â€”</strong></span>
    </div>

    <!-- Tablo -->
    <div class="table-wrap">
      <table id="invoiceTable">
        <thead>
          <tr>
            <th class="th-chk"><input type="checkbox" id="selAll"></th>
            <th data-col="filename">Dosya</th>
            <th data-col="vendor">Firma</th>
            <th data-col="date">Tarih</th>
            <th data-col="time">Saat</th>
            <th data-col="total"  class="num">Tutar</th>
            <th data-col="vat_rate" class="num">KDV%</th>
            <th data-col="vat_amount" class="num">KDV TutarÄ±</th>
            <th data-col="invoice_no">Fatura No</th>
            <th data-col="category">Kategori</th>
            <th data-col="payment_method">Ã–deme</th>
            <th>QR</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tBody"></tbody>
        <tfoot id="tFoot">
          <tr class="excel-footer">
            <td colspan="2" class="ef-label">
              <select id="efFunc" class="ef-select" title="Fonksiyon seÃ§">
                <option value="SUM">âˆ‘ TOPLAM</option>
                <option value="AVG">âˆ… ORTALAMA</option>
                <option value="MIN">â†“ MÄ°N</option>
                <option value="MAX">â†‘ MAKS</option>
                <option value="COUNT">N ADET</option>
                <option value="POS">+ POZÄ°TÄ°F TOP.</option>
                <option value="NEG">â€“ NEGATÄ°F TOP.</option>
              </select>
            </td>
            <td class="ef-vendor"></td>
            <td class="ef-date"></td>
            <td></td>
            <td class="num ef-total" id="efTotal">â€”</td>
            <td class="num ef-vat-rate" id="efVatRate">â€”</td>
            <td class="num ef-vat" id="efVat">â€”</td>
            <td></td>
            <td colspan="4" class="ef-info" id="efInfo"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
  </section>

  <!-- â”€â”€â”€ Ä°NCELEME KUYRUÄU â”€â”€â”€ -->
  <section id="view-review" class="view">
    <div class="page-header">
      <h1>Ä°nceleme KuyruÄŸu</h1>
      <div class="page-actions">
        <span id="rqCount" class="kpi-chip">0 bekliyor</span>
        <button id="rqRefresh" class="btn btn-outline">Yenile</button>
        <a id="rqExportExcel" href="/api/stats/export/review-queue-excel" class="btn btn-warning" download>
          Excel Ä°ndir
        </a>
        <a id="rqExportCsv" href="/api/stats/export/review-queue-csv" class="btn btn-outline" download>
          CSV Ä°ndir
        </a>
      </div>
    </div>

    <!-- UyarÄ± banner -->
    <div class="review-banner" id="rqBanner" style="display:none">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <div>
        <strong>Okunamayan / Eksik Faturalar</strong>
        <p id="rqBannerMsg">AÅŸaÄŸÄ±daki faturalarda bazÄ± bilgiler tespit edilemedi. LÃ¼tfen elle girin veya geÃ§in.</p>
      </div>
    </div>

    <div id="reviewList" class="review-list"></div>
    <div class="pagination" id="rqPagination"></div>
  </section>

  <!-- â”€â”€â”€ Ä°STATÄ°STÄ°K â”€â”€â”€ -->
  <section id="view-stats" class="view">
    <div class="page-header"><h1>Ä°statistik &amp; Sorgulama</h1></div>
    <div class="stats-form">
      <div class="fg"><label>BaÅŸlangÄ±Ã§</label><input type="date" id="sDateFrom"></div>
      <div class="fg"><label>BitiÅŸ</label><input type="date" id="sDateTo"></div>
      <div class="fg fg-grow"><label>Firma</label><input type="text" id="sVendor" placeholder="TÃ¼mÃ¼"></div>
      <div class="fg">
        <label>Kategori</label>
        <select id="sCategory">
          <option value="">TÃ¼mÃ¼</option>
          <option value="food">Yemek</option>
          <option value="grocery">Market</option>
          <option value="transport">UlaÅŸÄ±m</option>
          <option value="fuel">AkaryakÄ±t</option>
          <option value="hotel">Otel</option>
          <option value="health">SaÄŸlÄ±k</option>
          <option value="electronics">Elektronik</option>
          <option value="clothing">Giyim</option>
        </select>
      </div>
      <div class="fg"><label>Min Tutar</label><input type="number" id="sMin"></div>
      <div class="fg"><label>Max Tutar</label><input type="number" id="sMax"></div>
      <button id="runStats" class="btn btn-primary" style="align-self:flex-end">Sorgula</button>
    </div>
    <div id="statsResult" class="stats-result"></div>
  </section>

</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â• -->
<div id="modal" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <div class="modal-hdr">
      <h2 id="modalTitle">Detay</h2>
      <button id="modalClose" class="btn-icon">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="detailGrid" class="detail-grid"></div>
      <div class="detail-section">
        <h4>QR / Barkod</h4>
        <pre id="detailQR">â€”</pre>
      </div>
      <div class="detail-section">
        <h4>OCR Ham Metin</h4>
        <pre id="detailRaw">â€”</pre>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MANUEL DÃœZELTME MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="editModal" class="modal-overlay" style="display:none">
  <div class="modal-box modal-edit">
    <div class="modal-hdr">
      <div>
        <h2 id="editModalTitle">Fatura DÃ¼zenle</h2>
        <p id="editModalSub" style="font-size:12px;color:#64748b;margin-top:2px"></p>
      </div>
      <button id="editModalClose" class="btn-icon">âœ•</button>
    </div>

    <!-- UyarÄ± ÅŸeridi -->
    <div id="editWarning" class="edit-warning" style="display:none">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <span id="editWarningMsg"></span>
    </div>

    <div class="modal-body">
      <input type="hidden" id="editInvId">
      <div class="edit-grid">
        <div class="eg">
          <label>Firma AdÄ±</label>
          <input type="text" id="eVendor" placeholder="Firma adÄ±â€¦">
        </div>
        <div class="eg">
          <label>Fatura No</label>
          <input type="text" id="eInvoiceNo" placeholder="Fatura numarasÄ±â€¦">
        </div>
        <div class="eg">
          <label>Tarih</label>
          <input type="date" id="eDate">
        </div>
        <div class="eg">
          <label>Saat</label>
          <input type="time" id="eTime">
        </div>
        <div class="eg eg-required">
          <label>Toplam Tutar <span class="req-star">*</span></label>
          <input type="number" id="eTotal" step="0.01" placeholder="0.00" required>
        </div>
        <div class="eg">
          <label>KDV %</label>
          <input type="number" id="eVatRate" step="1" min="0" max="100" placeholder="19">
        </div>
        <div class="eg">
          <label>KDV TutarÄ±</label>
          <input type="number" id="eVatAmount" step="0.01" placeholder="0.00">
        </div>
        <div class="eg">
          <label>Kategori</label>
          <select id="eCategory">
            <option value="">â€” SeÃ§in â€”</option>
            <option value="food">Yemek</option>
            <option value="grocery">Market</option>
            <option value="transport">UlaÅŸÄ±m</option>
            <option value="fuel">AkaryakÄ±t</option>
            <option value="hotel">Otel</option>
            <option value="health">SaÄŸlÄ±k</option>
            <option value="electronics">Elektronik</option>
            <option value="clothing">Giyim</option>
            <option value="other">DiÄŸer</option>
          </select>
        </div>
        <div class="eg">
          <label>Ã–deme YÃ¶ntemi</label>
          <select id="ePayment">
            <option value="">â€” SeÃ§in â€”</option>
            <option value="cash">Nakit</option>
            <option value="credit_card">Kredi KartÄ±</option>
            <option value="debit_card">Banka KartÄ±</option>
            <option value="bank_transfer">Havale</option>
          </select>
        </div>
      </div>

      <!-- KDV otomatik hesap -->
      <div class="vat-auto-row">
        <label class="checkbox-label">
          <input type="checkbox" id="eVatAuto" checked>
          KDV tutarÄ±nÄ± otomatik hesapla (Tutar Ã— KDV%)
        </label>
      </div>

      <div class="edit-actions">
        <button id="editSkipBtn" class="btn btn-ghost">GeÃ§ (Ä°ncelemeden KaldÄ±r)</button>
        <button id="editSaveBtn" class="btn btn-primary">Kaydet</button>
      </div>

      <div id="editFeedback" class="edit-feedback" style="display:none"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="app.js" type="module"></script>

<!-- â”€â”€ Muhasebe Defteri View â”€â”€ -->
<section id="view-settings" class="view" style="display:none">
  <div class="page-header"><h2>Dil AyarlarÄ±</h2></div>
  <div class="card" style="max-width:480px">
    <h3 style="margin-bottom:16px">ArayÃ¼z Dili</h3>
    <div style="display:flex;flex-direction:column;gap:10px">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="tr" checked> ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e
      </label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="de"> ğŸ‡©ğŸ‡ª Deutsch
      </label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="en"> ğŸ‡¬ğŸ‡§ English
      </label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="ar"> ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
      </label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="fr"> ğŸ‡«ğŸ‡· FranÃ§ais
      </label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="es"> ğŸ‡ªğŸ‡¸ EspaÃ±ol
      </label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="ko"> ğŸ‡°ğŸ‡· í•œêµ­ì–´
      </label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border-radius:8px;border:2px solid var(--border)">
        <input type="radio" name="appLang" value="zh"> ğŸ‡¨ğŸ‡³ ä¸­æ–‡
      </label>
    </div>
    <button class="btn-primary" style="margin-top:20px;width:100%" onclick="saveLangSetting()">Kaydet</button>
    <p id="langSaveMsg" style="color:var(--success);margin-top:10px;display:none">âœ“ Dil ayarÄ± kaydedildi!</p>
  </div>
  <div class="card" style="max-width:480px;margin-top:20px">
    <h3 style="margin-bottom:16px">Para Birimi</h3>
    <select id="currencySelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)">
      <option value="EUR">â‚¬ Euro (EUR)</option>
      <option value="USD">$ Dolar (USD)</option>
      <option value="TRY">â‚º TÃ¼rk LirasÄ± (TRY)</option>
      <option value="GBP">Â£ Ä°ngiliz Sterlini (GBP)</option>
      <option value="CHF">â‚£ Ä°sviÃ§re FrangÄ± (CHF)</option>
    </select>
    <button class="btn-primary" style="margin-top:12px;width:100%" onclick="saveCurrencySetting()">Kaydet</button>
  </div>
</section>


  <div class="view-header">
    <h1>Muhasebe Defteri</h1>
    <div class="page-actions">
      <a id="ldgExcel" href="/api/stats/export/ledger-excel" class="btn btn-success" download>Excel Ä°ndir</a>
    </div>
  </div>

  <!-- Filtreler -->
  <div class="filter-bar">
    <input type="date" id="ldgStart" class="input" placeholder="BaÅŸlangÄ±Ã§">
    <input type="date" id="ldgEnd"   class="input" placeholder="BitiÅŸ">
    <input type="text" id="ldgVendor" class="input" placeholder="Firma adÄ±...">
    <button id="ldgFilter" class="btn btn-primary">Filtrele</button>
    <button id="ldgReset"  class="btn btn-ghost">Temizle</button>
  </div>

  <!-- KPI Kartlar -->
  <div class="kpi-grid" id="ldgKpi">
    <div class="kpi-card kpi-income">
      <span class="kpi-label">Toplam Gelir</span>
      <span class="kpi-value" id="ldgIncome">â€”</span>
      <span class="kpi-sub" id="ldgIncomeCount">0 fatura</span>
    </div>
    <div class="kpi-card kpi-expense">
      <span class="kpi-label">Toplam Gider</span>
      <span class="kpi-value" id="ldgExpense">â€”</span>
      <span class="kpi-sub" id="ldgExpenseCount">0 fatura</span>
    </div>
    <div class="kpi-card kpi-net" id="ldgNetCard">
      <span class="kpi-label">NET Bakiye</span>
      <span class="kpi-value" id="ldgNet">â€”</span>
      <span class="kpi-sub" id="ldgNetLabel">â€”</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">KDV (AlÄ±nan)</span>
      <span class="kpi-value" id="ldgVatIncome">â€”</span>
      <span class="kpi-sub" id="ldgVatExpense">Ã–denen: â€”</span>
    </div>
  </div>

  <!-- AylÄ±k Ã–zet Tablosu -->
  <div class="table-card">
    <h3>AylÄ±k Ã–zet</h3>
    <div class="table-wrap">
      <table class="inv-table" id="ldgMonthlyTable">
        <thead>
          <tr>
            <th>Ay</th>
            <th>Gelir</th>
            <th>Gider</th>
            <th>NET</th>
            <th>Fatura</th>
          </tr>
        </thead>
        <tbody id="ldgMonthlyBody"></tbody>
        <tfoot>
          <tr id="ldgMonthlyFoot" class="table-footer-total">
            <td><b>TOPLAM</b></td>
            <td id="ldgFtIncome">â€”</td>
            <td id="ldgFtExpense">â€”</td>
            <td id="ldgFtNet">â€”</td>
            <td id="ldgFtCount">â€”</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Fatura Listesi -->
  <div class="table-card">
    <h3>Fatura Listesi
      <span class="badge-count" id="ldgPageInfo" style="display:inline;margin-left:8px;font-size:12px"></span>
    </h3>
    <div class="table-wrap">
      <table class="inv-table" id="ldgTable">
        <thead>
          <tr>
            <th>TÃ¼r</th>
            <th>Tarih</th>
            <th>Firma</th>
            <th>Tutar</th>
            <th>KDV</th>
            <th>Kategori</th>
            <th>Ã–deme</th>
          </tr>
        </thead>
        <tbody id="ldgBody"></tbody>
      </table>
    </div>
    <div class="pagination" id="ldgPagination"></div>
  </div>
</section>

</body>
</html>
