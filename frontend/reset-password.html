<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Şifre Sıfırla — AutoTax.cloud</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --brand: #2563eb; --brand-d: #1d4ed8;
      --bg: #f1f5f9; --text: #0f172a; --muted: #64748b;
      --border: #e2e8f0; --error: #ef4444; --success: #22c55e;
    }
    body { min-height:100vh; display:flex; align-items:center; justify-content:center;
           background:var(--bg); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; padding:20px; }
    .card { background:#fff; border-radius:16px; padding:40px 36px; width:100%; max-width:420px;
            box-shadow:0 4px 24px rgba(0,0,0,.08); }
    .logo { display:flex; align-items:center; gap:10px; font-size:20px; font-weight:800; color:var(--brand); margin-bottom:28px; }
    h2 { font-size:22px; font-weight:700; color:var(--text); margin-bottom:6px; }
    p.sub { color:var(--muted); font-size:14px; margin-bottom:24px; }
    label { display:block; font-size:13px; font-weight:600; color:#374151; margin-bottom:6px; }
    .input-wrap { position:relative; margin-bottom:16px; }
    input[type=password], input[type=text] {
      width:100%; padding:11px 44px 11px 14px; border:1.5px solid var(--border);
      border-radius:10px; font-size:14px; outline:none; transition:border-color .2s;
    }
    input:focus { border-color:var(--brand); }
    .eye-btn { position:absolute; right:12px; top:50%; transform:translateY(-50%);
               background:none; border:none; cursor:pointer; color:var(--muted); padding:4px; }
    .btn { width:100%; padding:13px; background:var(--brand); color:#fff; border:none;
           border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:background .2s; margin-top:4px; }
    .btn:hover { background:var(--brand-d); }
    .btn:disabled { background:#93c5fd; cursor:not-allowed; }
    .alert { padding:12px 16px; border-radius:10px; font-size:14px; margin-bottom:16px; display:none; }
    .alert.error   { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; display:block; }
    .alert.success { background:#f0fdf4; color:#16a34a; border:1px solid #bbf7d0; display:block; }
    .pw-bar-wrap { display:flex; gap:4px; margin-top:6px; margin-bottom:4px; }
    .pw-bar { height:4px; flex:1; border-radius:2px; background:#e2e8f0; transition:background .3s; }
    .back { display:inline-block; margin-top:20px; color:var(--brand); font-size:14px; text-decoration:none; }
    .back:hover { text-decoration:underline; }
  </style>
</head>
<body>
<div class="card">
  <div class="logo">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-4 0v2M12 12v3"/>
    </svg>
    AutoTax.cloud
  </div>

  <h2>Yeni Şifre Belirle</h2>
  <p class="sub">En az 8 karakter, güçlü bir şifre seçin.</p>

  <div id="alertBox" class="alert"></div>

  <form id="resetForm">
    <div>
      <label for="pw1">Yeni Şifre</label>
      <div class="input-wrap">
        <input type="password" id="pw1" placeholder="Minimum 8 karakter" required>
        <button type="button" class="eye-btn" id="toggle1">
          <svg id="eye1" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>
      <div class="pw-bar-wrap">
        <div class="pw-bar" id="b1"></div><div class="pw-bar" id="b2"></div>
        <div class="pw-bar" id="b3"></div><div class="pw-bar" id="b4"></div>
      </div>
    </div>

    <div>
      <label for="pw2">Şifre Tekrar</label>
      <div class="input-wrap">
        <input type="password" id="pw2" placeholder="Şifrenizi tekrar girin" required>
        <button type="button" class="eye-btn" id="toggle2">
          <svg id="eye2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>
    </div>

    <button type="submit" class="btn" id="submitBtn">Şifremi Güncelle</button>
  </form>
  <a href="/login.html" class="back">← Giriş sayfasına dön</a>
</div>

<script>
const API = '/api';
const params = new URLSearchParams(window.location.search);
const token  = params.get('token');
const alertBox = document.getElementById('alertBox');

// Token yoksa hata göster
if (!token) {
  alertBox.className = 'alert error';
  alertBox.textContent = 'Geçersiz bağlantı. Lütfen "Şifremi unuttum" sayfasından tekrar isteyin.';
  document.getElementById('resetForm').style.display = 'none';
} else {
  // Token geçerliliğini kontrol et
  fetch(`${API}/auth/verify-reset-token?token=${encodeURIComponent(token)}`)
    .then(r => r.json())
    .then(d => {
      if (!d.valid) {
        alertBox.className = 'alert error';
        alertBox.textContent = 'Bağlantının süresi dolmuş veya geçersiz. Lütfen tekrar isteyin.';
        document.getElementById('resetForm').style.display = 'none';
      }
    }).catch(() => {});
}

// Göz ikonları
function makeToggle(btnId, inputId, iconId) {
  document.getElementById(btnId).addEventListener('click', function() {
    const inp = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    const show = inp.type === 'password';
    inp.type = show ? 'text' : 'password';
    icon.innerHTML = show
      ? `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>`
      : `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>`;
  });
}
makeToggle('toggle1', 'pw1', 'eye1');
makeToggle('toggle2', 'pw2', 'eye2');

// Şifre gücü göstergesi
const colors = ['#ef4444','#f97316','#eab308','#22c55e'];
document.getElementById('pw1').addEventListener('input', function() {
  const v = this.value;
  let score = 0;
  if (v.length >= 8) score++;
  if (/[A-Z]/.test(v)) score++;
  if (/[0-9]/.test(v)) score++;
  if (/[^A-Za-z0-9]/.test(v)) score++;
  ['b1','b2','b3','b4'].forEach((id, i) => {
    document.getElementById(id).style.background = i < score ? colors[score - 1] : '#e2e8f0';
  });
});

// Form gönder
document.getElementById('resetForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const pw1 = document.getElementById('pw1').value;
  const pw2 = document.getElementById('pw2').value;
  const btn = document.getElementById('submitBtn');

  alertBox.className = 'alert';
  alertBox.textContent = '';

  if (pw1 !== pw2) {
    alertBox.className = 'alert error';
    alertBox.textContent = 'Şifreler eşleşmiyor.';
    return;
  }
  if (pw1.length < 8) {
    alertBox.className = 'alert error';
    alertBox.textContent = 'Şifre en az 8 karakter olmalıdır.';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Güncelleniyor...';

  try {
    const res = await fetch(`${API}/auth/reset-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, password: pw1 })
    });
    const data = await res.json();
    if (res.ok) {
      alertBox.className = 'alert success';
      alertBox.textContent = '✓ Şifreniz güncellendi! 3 saniye içinde giriş sayfasına yönlendiriliyorsunuz...';
      document.getElementById('resetForm').style.display = 'none';
      setTimeout(() => window.location.href = '/login.html', 3000);
    } else {
      alertBox.className = 'alert error';
      alertBox.textContent = data.detail || 'Bir hata oluştu.';
      btn.disabled = false;
      btn.textContent = 'Şifremi Güncelle';
    }
  } catch {
    alertBox.className = 'alert error';
    alertBox.textContent = 'Bağlantı hatası. Lütfen tekrar deneyin.';
    btn.disabled = false;
    btn.textContent = 'Şifremi Güncelle';
  }
});
</script>
</body>
</html>
